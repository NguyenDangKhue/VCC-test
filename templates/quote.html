{% extends "base.html" %}
{% block title %}Báo giá - Viettel Construction Lâm Đồng{% endblock %}
{% block content %}
<section class="page-header text-white">
  <div class="container py-5">
    <h1 class="fw-bold">Báo giá</h1>
    <p class="mb-0">Tính toán báo giá xây dựng cho công trình của bạn.</p>
  </div>
  <div class="hero-gradient"></div>
</section>

<section class="py-5">
  <div class="container">
    <div class="row">
      <div class="col-lg-11 mx-auto">
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4">
            <h3 class="mb-4">Công cụ tính báo giá xây dựng</h3>
            <p class="text-muted mb-4">
              Chọn các hạng mục cần khai báo, nhập diện tích và chọn mức giá. Hệ thống sẽ tự động tính toán tổng giá trị.
            </p>
            
            <form id="quoteForm">
              <!-- Chọn hạng mục cần khai báo -->
              <div class="mb-4 p-3 card-neutral">
                <div class="section-title"><span>Chọn hạng mục cần khai báo diện tích</span></div>
                <div class="row" id="hangMucCheckboxes">
                  <!-- Will be generated by JavaScript -->
                </div>
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-ghost" onclick="selectAllHangMuc()">Chọn tất cả</button>
                  <button type="button" class="btn btn-sm btn-ghost" onclick="deselectAllHangMuc()">Bỏ chọn tất cả</button>
                </div>
              </div>

              <!-- Phần Xây thô -->
              <div class="card mb-4 card-neutral">
                <div class="p-3">
                  <div class="section-title"><span>Phần Xây thô</span></div>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <label for="gia_xay_tho" class="form-label fw-bold">
                        Giá xây thô (VNĐ/m²) <span class="text-danger">*</span>
                      </label>
                      <select class="form-select" id="gia_xay_tho" name="gia_xay_tho">
                        <option value="">-- Chọn mức giá --</option>
                        {% for gia in gia_xay_tho %}
                        <option value="{{ gia.gia }}">{{ gia.mo_ta }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <button type="button" class="btn btn-brand w-100 fw-bold" onclick="showVatTuModal('xay_tho')" style="font-size: 1rem; padding: 0.75rem;">
                        <i class="bi bi-info-circle me-2"></i>Tra cứu vật tư theo đơn giá
                      </button>
                    </div>
                  </div>
                  
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead>
                        <tr>
                          <th style="width: 40%;">Hạng mục</th>
                          <th style="width: 15%;" class="text-center">Hệ số</th>
                          <th style="width: 25%;">Diện tích (m²)</th>
                          <th style="width: 20%;" class="text-end">Thành tiền</th>
                        </tr>
                      </thead>
                      <tbody id="xayThoTable">
                        <!-- Rows will be generated by JavaScript -->
                      </tbody>
                      <tfoot>
                        <tr>
                          <th colspan="3" class="text-end">TỔNG XÂY THÔ:</th>
                          <th class="text-end text-brand fw-bold" id="tongXayTho">0 VNĐ</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Phần Hoàn thiện -->
              <div class="card mb-4 card-neutral">
                <div class="p-3">
                  <div class="section-title"><span>Phần Hoàn thiện</span></div>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-12">
                      <label for="gia_hoan_thien" class="form-label fw-bold">
                        Giá hoàn thiện (VNĐ/m²) <span class="text-danger">*</span>
                      </label>
                      <select class="form-select" id="gia_hoan_thien" name="gia_hoan_thien">
                        <option value="">-- Chọn mức giá --</option>
                        {% for gia in gia_hoan_thien %}
                        <option value="{{ gia.gia }}">{{ gia.mo_ta }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead>
                        <tr>
                          <th style="width: 40%;">Hạng mục</th>
                          <th style="width: 15%;" class="text-center">Hệ số</th>
                          <th style="width: 25%;">Diện tích (m²)</th>
                          <th style="width: 20%;" class="text-end">Thành tiền</th>
                        </tr>
                      </thead>
                      <tbody id="hoanThienTable">
                        <!-- Rows will be generated by JavaScript -->
                      </tbody>
                      <tfoot>
                        <tr>
                          <th colspan="3" class="text-end">TỔNG HOÀN THIỆN:</th>
                          <th class="text-end text-brand fw-bold" id="tongHoanThien">0 VNĐ</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Tổng giá công trình -->
              <div class="card mb-4 card-neutral">
                <div class="p-3">
                  <div class="section-title"><span>Tổng giá công trình</span></div>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p class="mb-1"><strong>Tổng xây thô:</strong></p>
                      <p class="text-brand fw-bold fs-5" id="tongXayThoDisplay">0 VNĐ</p>
                    </div>
                    <div class="col-md-6">
                      <p class="mb-1"><strong>Tổng hoàn thiện:</strong></p>
                      <p class="text-brand fw-bold fs-5" id="tongHoanThienDisplay">0 VNĐ</p>
                    </div>
                  </div>
                  <hr>
                  <div class="text-center">
                    <p class="mb-1"><strong>TỔNG GIÁ CÔNG TRÌNH:</strong></p>
                    <p class="text-brand fw-bold" style="font-size: 2rem;" id="tongCongTrinh">0 VNĐ</p>
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                  <i class="bi bi-arrow-clockwise me-2"></i>Làm mới
                </button>
                <button type="button" class="btn btn-brand" onclick="printQuote()">
                  <i class="bi bi-printer me-2"></i>In báo giá
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Thông tin liên hệ -->
        <div class="text-center">
          <p class="text-muted mb-2">Cần tư vấn chi tiết? Liên hệ với chúng tôi:</p>
          <p class="mb-1">
            <i class="bi bi-telephone me-2"></i>
            <strong>Hotline:</strong> <a href="tel:1900123456" class="text-decoration-none">1900 123 456</a>
          </p>
          <p class="mb-0">
            <i class="bi bi-envelope me-2"></i>
            <strong>Email:</strong> <a href="mailto:info@viettelconstruction.vn" class="text-decoration-none">info@viettelconstruction.vn</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal Tra cứu Vật tư -->
<div class="modal fade" id="vatTuModal" tabindex="-1" aria-labelledby="vatTuModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="vatTuModalLabel">Tra cứu vật tư theo đơn giá</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="selectLoaiVatTu" class="form-label fw-bold">Loại:</label>
          <select class="form-select" id="selectLoaiVatTu" onchange="changeLoaiVatTu()">
            <option value="xay_tho">Xây thô</option>
            <option value="hoan_thien">Hoàn thiện</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="selectGiaVatTu" class="form-label fw-bold">Chọn đơn giá:</label>
          <select class="form-select" id="selectGiaVatTu" onchange="loadVatTu()">
            <option value="">-- Chọn đơn giá --</option>
          </select>
        </div>
        <div id="vatTuContent">
          <div class="text-center text-muted py-4">
            <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
            <p class="mt-2">Vui lòng chọn đơn giá để xem chi tiết vật tư</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Load dữ liệu từ server
const hangMucData = {{ hang_muc | tojson | safe }};
const giaXayThoData = {{ gia_xay_tho | tojson | safe }};
const giaHoanThienData = {{ gia_hoan_thien | tojson | safe }};
const vatTuData = {{ vat_tu | tojson | safe }};

let selectedHangMuc = new Set();

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Format currency
function formatCurrency(amount) {
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND'
  }).format(amount);
}

// Khởi tạo checkbox hạng mục
function initHangMucCheckboxes() {
  const container = document.getElementById('hangMucCheckboxes');
  container.innerHTML = '';
  
  hangMucData.forEach((item, index) => {
    const col = document.createElement('div');
    col.className = 'col-md-4 col-lg-3 mb-2';
    col.innerHTML = `
      <div class="form-check">
        <input class="form-check-input hang-muc-checkbox" 
               type="checkbox" 
               id="check_${item.id}" 
               value="${item.id}"
               onchange="toggleHangMuc('${item.id}')">
        <label class="form-check-label" for="check_${item.id}">
          ${escapeHtml(item.name)}
        </label>
      </div>
    `;
    container.appendChild(col);
  });
}

// Toggle hạng mục
function toggleHangMuc(hangMucId) {
  const checkbox = document.getElementById(`check_${hangMucId}`);
  if (checkbox.checked) {
    selectedHangMuc.add(hangMucId);
  } else {
    selectedHangMuc.delete(hangMucId);
    // Reset input values
    const xayThoInput = document.getElementById(`xaytho_${hangMucId}`);
    const hoanThienInput = document.getElementById(`hoanthien_${hangMucId}`);
    if (xayThoInput) xayThoInput.value = 0;
    if (hoanThienInput) hoanThienInput.value = 0;
  }
  updateTables();
  calculateAll();
}

// Chọn tất cả
function selectAllHangMuc() {
  document.querySelectorAll('.hang-muc-checkbox').forEach(cb => {
    cb.checked = true;
    selectedHangMuc.add(cb.value);
  });
  updateTables();
  calculateAll();
}

// Bỏ chọn tất cả
function deselectAllHangMuc() {
  document.querySelectorAll('.hang-muc-checkbox').forEach(cb => {
    cb.checked = false;
    selectedHangMuc.delete(cb.value);
  });
  selectedHangMuc.clear();
  updateTables();
  calculateAll();
}

// Cập nhật bảng
function updateTables() {
  const xayThoTable = document.getElementById('xayThoTable');
  const hoanThienTable = document.getElementById('hoanThienTable');
  
  xayThoTable.innerHTML = '';
  hoanThienTable.innerHTML = '';
  
  hangMucData.forEach(item => {
    if (selectedHangMuc.has(item.id)) {
      // Row cho xây thô
      const rowTho = document.createElement('tr');
      rowTho.innerHTML = `
        <td>${escapeHtml(item.name)}</td>
        <td class="text-center"><span class="badge bg-secondary">${item.he_so}</span></td>
        <td>
          <input type="number" 
                 class="form-control form-control-sm dien-tich-xay-tho" 
                 id="xaytho_${item.id}" 
                 data-hang-muc-id="${item.id}"
                 data-he-so="${item.he_so}"
                 min="0" 
                 step="0.01" 
                 value="0"
                 placeholder="0">
        </td>
        <td class="text-end thanh-tien-xay-tho" data-id="${item.id}">0 VNĐ</td>
      `;
      xayThoTable.appendChild(rowTho);
      
      // Row cho hoàn thiện
      const rowHT = document.createElement('tr');
      rowHT.innerHTML = `
        <td>${escapeHtml(item.name)}</td>
        <td class="text-center"><span class="badge bg-secondary">${item.he_so}</span></td>
        <td>
          <input type="number" 
                 class="form-control form-control-sm dien-tich-hoan-thien" 
                 id="hoanthien_${item.id}" 
                 data-hang-muc-id="${item.id}"
                 data-he-so="${item.he_so}"
                 min="0" 
                 step="0.01" 
                 value="0"
                 placeholder="0">
        </td>
        <td class="text-end thanh-tien-hoan-thien" data-id="${item.id}">0 VNĐ</td>
      `;
      hoanThienTable.appendChild(rowHT);
    }
  });
  
  // Thêm event listeners
  document.querySelectorAll('.dien-tich-xay-tho').forEach(input => {
    input.addEventListener('input', calculateAll);
  });
  
  document.querySelectorAll('.dien-tich-hoan-thien').forEach(input => {
    input.addEventListener('input', calculateAll);
  });
  
  document.getElementById('gia_xay_tho').addEventListener('change', calculateAll);
  document.getElementById('gia_hoan_thien').addEventListener('change', calculateAll);
}

// Tính toán tất cả
function calculateAll() {
  const giaXayTho = parseFloat(document.getElementById('gia_xay_tho').value) || 0;
  const giaHoanThien = parseFloat(document.getElementById('gia_hoan_thien').value) || 0;
  
  let tongXayTho = 0;
  let tongHoanThien = 0;
  
  // Tính xây thô
  if (giaXayTho > 0) {
    document.querySelectorAll('.dien-tich-xay-tho').forEach(input => {
      const dienTich = parseFloat(input.value) || 0;
      const heSo = parseFloat(input.getAttribute('data-he-so'));
      const thanhTien = dienTich * heSo * giaXayTho;
      
      const thanhTienCell = document.querySelector(`.thanh-tien-xay-tho[data-id="${input.getAttribute('data-hang-muc-id')}"]`);
      if (thanhTienCell) {
        thanhTienCell.textContent = formatCurrency(thanhTien);
      }
      
      tongXayTho += thanhTien;
    });
  } else {
    document.querySelectorAll('.thanh-tien-xay-tho').forEach(cell => {
      cell.textContent = '0 VNĐ';
    });
  }
  
  // Tính hoàn thiện
  if (giaHoanThien > 0) {
    document.querySelectorAll('.dien-tich-hoan-thien').forEach(input => {
      const dienTich = parseFloat(input.value) || 0;
      const heSo = parseFloat(input.getAttribute('data-he-so'));
      const thanhTien = dienTich * heSo * giaHoanThien;
      
      const thanhTienCell = document.querySelector(`.thanh-tien-hoan-thien[data-id="${input.getAttribute('data-hang-muc-id')}"]`);
      if (thanhTienCell) {
        thanhTienCell.textContent = formatCurrency(thanhTien);
      }
      
      tongHoanThien += thanhTien;
    });
  } else {
    document.querySelectorAll('.thanh-tien-hoan-thien').forEach(cell => {
      cell.textContent = '0 VNĐ';
    });
  }
  
  // Cập nhật tổng
  document.getElementById('tongXayTho').textContent = formatCurrency(tongXayTho);
  document.getElementById('tongHoanThien').textContent = formatCurrency(tongHoanThien);
  document.getElementById('tongXayThoDisplay').textContent = formatCurrency(tongXayTho);
  document.getElementById('tongHoanThienDisplay').textContent = formatCurrency(tongHoanThien);
  
  const tongCongTrinh = tongXayTho + tongHoanThien;
  document.getElementById('tongCongTrinh').textContent = formatCurrency(tongCongTrinh);
}

// Reset form
function resetForm() {
  document.getElementById('quoteForm').reset();
  selectedHangMuc.clear();
  document.querySelectorAll('.hang-muc-checkbox').forEach(cb => cb.checked = false);
  updateTables();
  calculateAll();
}

// Print quote
function printQuote() {
  window.print();
}

// Hiển thị modal tra cứu vật tư
function showVatTuModal(loai = 'xay_tho') {
  const modal = new bootstrap.Modal(document.getElementById('vatTuModal'));
  document.getElementById('selectLoaiVatTu').value = loai;
  changeLoaiVatTu();
  modal.show();
}

// Thay đổi loại vật tư (xây thô/hoàn thiện)
function changeLoaiVatTu() {
  const loai = document.getElementById('selectLoaiVatTu').value;
  const selectGia = document.getElementById('selectGiaVatTu');
  const content = document.getElementById('vatTuContent');
  
  // Clear current selection
  selectGia.innerHTML = '<option value="">-- Chọn đơn giá --</option>';
  content.innerHTML = `
    <div class="text-center text-muted py-4">
      <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
      <p class="mt-2">Vui lòng chọn đơn giá để xem chi tiết vật tư</p>
    </div>
  `;
  
  // Populate price options based on type
  if (loai === 'xay_tho') {
    giaXayThoData.forEach(gia => {
      const option = document.createElement('option');
      option.value = gia.gia;
      option.textContent = gia.mo_ta;
      selectGia.appendChild(option);
    });
  } else if (loai === 'hoan_thien') {
    giaHoanThienData.forEach(gia => {
      const option = document.createElement('option');
      option.value = gia.gia;
      option.textContent = gia.mo_ta;
      selectGia.appendChild(option);
    });
  }
}

// Load vật tư theo giá
function loadVatTu() {
  const loai = document.getElementById('selectLoaiVatTu').value;
  const gia = document.getElementById('selectGiaVatTu').value;
  const content = document.getElementById('vatTuContent');
  
  if (!gia) {
    content.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
        <p class="mt-2">Vui lòng chọn đơn giá để xem chi tiết vật tư</p>
      </div>
    `;
    return;
  }
  
  // Check if loai exists in vatTuData
  if (!vatTuData || !vatTuData[loai]) {
    content.innerHTML = `
      <div class="text-center text-danger py-4">
        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
        <p class="mt-2">Không tìm thấy dữ liệu vật tư cho loại: ${loai}</p>
      </div>
    `;
    return;
  }
  
  // Try both string and number key
  const giaKey = gia.toString();
  let vatTu = vatTuData[loai][giaKey] || vatTuData[loai][parseInt(gia)];
  
  if (!vatTu) {
    content.innerHTML = `
      <div class="text-center text-danger py-4">
        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
        <p class="mt-2">Không tìm thấy dữ liệu vật tư cho đơn giá: ${gia}</p>
        <p class="text-muted small">Loại: ${loai}, Giá: ${gia}</p>
        <p class="text-muted small">Các key có sẵn: ${Object.keys(vatTuData[loai] || {}).join(', ')}</p>
      </div>
    `;
    return;
  }
  let html = `
    <div class="vat-tu-header mb-4">
      <h6 class="text-brand fw-bold mb-0">${escapeHtml(vatTu.mo_ta)}</h6>
    </div>
  `;
  
  vatTu.categories.forEach(category => {
    html += `
      <div class="vat-tu-category mb-4">
        <h6 class="category-title mb-3">${escapeHtml(category.name)}</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th style="width: 35%;">Loại Vật tư/Hạng mục</th>
                <th>Chi tiết Vật tư được Trang bị</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    category.items.forEach(item => {
      html += `
        <tr>
          <td class="fw-semibold">${escapeHtml(item.ten)}</td>
          <td>${escapeHtml(item.chi_tiet)}</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  });
  
  content.innerHTML = html;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  initHangMucCheckboxes();
  updateTables();
});
</script>

<style>
@media print {
  .navbar, .footer, .btn, .page-header {
    display: none !important;
  }
  
  .card {
    border: none !important;
    box-shadow: none !important;
    page-break-inside: avoid;
  }
}

.text-brand {
  color: var(--brand-red);
}

/* Vật tư modal styles */
.vat-tu-header {
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--brand-red);
}

.vat-tu-category {
  margin-bottom: 2rem;
}

.category-title {
  color: var(--text-dark);
  font-weight: 600;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--brand-gray-200);
}

#vatTuModal .table {
  margin-bottom: 0;
}

#vatTuModal .table th {
  background-color: var(--brand-gray-100);
  font-weight: 600;
  color: var(--text-dark);
}

#vatTuModal .table td {
  vertical-align: middle;
}
</style>
{% endblock %}
